<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CNG Technology Guide</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #ffffff;
      --bg-secondary: #f9fafb;
      --bg-tertiary: #f3f4f6;
      --border: #e5e7eb;
      --border-light: #f3f4f6;
      --text: #111827;
      --text-secondary: #6b7280;
      --text-tertiary: #9ca3af;
      --accent: #2563eb;
      --accent-light: #eff6ff;
      --success: #10b981;
      --success-light: #ecfdf5;
      --danger: #ef4444;
      --danger-light: #fef2f2;
      --warning: #f59e0b;
      --warning-light: #fffbeb;
      --sidebar-width: 280px;
      --header-height: 56px;
      --transition: 150ms cubic-bezier(0.4, 0, 0.2, 1);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
    }

    /* Layout */
    .app { display: flex; min-height: 100vh; }

    /* Sidebar */
    .sidebar {
      width: var(--sidebar-width);
      background: var(--bg-secondary);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      position: fixed;
      top: 0;
      left: 0;
      bottom: 0;
      z-index: 100;
      transition: transform var(--transition);
    }

    .sidebar-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo {
      width: 32px;
      height: 32px;
      border-radius: 8px;
    }

    .logo-text {
      font-weight: 600;
      font-size: 14px;
      color: var(--text);
    }

    .logo-subtitle {
      font-size: 11px;
      color: var(--text-tertiary);
      font-weight: 500;
    }

    /* Search */
    .search-container {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border-light);
    }

    .search-input {
      width: 100%;
      padding: 8px 12px;
      padding-left: 36px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 13px;
      background: var(--bg);
      transition: all var(--transition);
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%239ca3af' stroke-width='2'%3E%3Ccircle cx='11' cy='11' r='8'/%3E%3Cpath d='m21 21-4.35-4.35'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: 10px center;
    }

    .search-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-light);
    }

    .search-input::placeholder { color: var(--text-tertiary); }

    /* Navigation */
    .nav-container {
      flex: 1;
      overflow-y: auto;
      padding: 8px 0;
    }

    .nav-section {
      margin-bottom: 4px;
    }

    .nav-section-header {
      display: flex;
      align-items: center;
      padding: 8px 16px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-tertiary);
      cursor: pointer;
      user-select: none;
    }

    .nav-section-header:hover { color: var(--text-secondary); }

    .nav-section-icon {
      margin-right: 8px;
      font-size: 14px;
      transition: transform var(--transition);
    }

    .nav-section.collapsed .nav-section-icon {
      transform: rotate(-90deg);
    }

    .nav-section.collapsed .nav-items {
      display: none;
    }

    .nav-items {
      margin: 0;
      padding: 0;
      list-style: none;
    }

    .nav-item {
      display: flex;
      align-items: center;
      padding: 8px 16px 8px 28px;
      font-size: 13px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all var(--transition);
      border-left: 2px solid transparent;
    }

    .nav-item:hover {
      background: var(--bg-tertiary);
      color: var(--text);
    }

    .nav-item.active {
      background: var(--accent-light);
      color: var(--accent);
      border-left-color: var(--accent);
      font-weight: 500;
    }

    .nav-item-icon {
      margin-right: 10px;
      font-size: 16px;
      opacity: 0.7;
    }

    .nav-badge {
      margin-left: auto;
      padding: 2px 6px;
      font-size: 10px;
      font-weight: 600;
      border-radius: 10px;
      background: var(--bg-tertiary);
      color: var(--text-tertiary);
    }

    /* Main Content */
    .main {
      flex: 1;
      margin-left: var(--sidebar-width);
      min-height: 100vh;
    }

    .main-header {
      position: sticky;
      top: 0;
      background: rgba(255,255,255,0.9);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border);
      padding: 16px 32px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      z-index: 50;
    }

    .breadcrumb {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: var(--text-tertiary);
    }

    .breadcrumb-item {
      cursor: pointer;
      transition: color var(--transition);
    }

    .breadcrumb-item:hover { color: var(--text); }
    .breadcrumb-current { color: var(--text); font-weight: 500; }
    .breadcrumb-sep { opacity: 0.5; }

    .main-content {
      padding: 32px;
      max-width: 900px;
    }

    /* Content Styles */
    .content-header {
      margin-bottom: 32px;
    }

    .content-title {
      font-size: 28px;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 8px;
      letter-spacing: -0.5px;
    }

    .content-description {
      font-size: 15px;
      color: var(--text-secondary);
      line-height: 1.6;
    }

    .context-tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      font-size: 11px;
      font-weight: 600;
      border-radius: 6px;
      margin-top: 12px;
    }

    .context-tag.school { background: var(--accent-light); color: var(--accent); }
    .context-tag.home { background: var(--warning-light); color: var(--warning); }
    .context-tag.shared { background: var(--success-light); color: var(--success); }

    /* Content Blocks */
    .content-block {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      margin-bottom: 16px;
      overflow: hidden;
      transition: box-shadow var(--transition);
    }

    .content-block:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }

    .block-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border-light);
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
    }

    .block-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .block-category {
      font-size: 11px;
      color: var(--text-tertiary);
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .block-expand {
      font-size: 18px;
      color: var(--text-tertiary);
      transition: transform var(--transition);
    }

    .content-block.expanded .block-expand {
      transform: rotate(180deg);
    }

    .block-content {
      padding: 0 20px;
      max-height: 0;
      overflow: hidden;
      transition: all 200ms ease-out;
    }

    .content-block.expanded .block-content {
      padding: 16px 20px;
      max-height: 2000px;
    }

    .block-text {
      font-size: 14px;
      color: var(--text-secondary);
      line-height: 1.7;
    }

    /* Tables */
    .table-container {
      overflow-x: auto;
      margin: -16px -20px;
      padding: 16px 20px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    th {
      text-align: left;
      padding: 12px 16px;
      font-weight: 600;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-tertiary);
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
    }

    td {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border-light);
      color: var(--text-secondary);
    }

    tr:last-child td { border-bottom: none; }
    tr:hover td { background: var(--bg-secondary); }

    .status {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 8px;
      font-size: 11px;
      font-weight: 600;
      border-radius: 4px;
    }

    .status.allow { background: var(--success-light); color: var(--success); }
    .status.block { background: var(--danger-light); color: var(--danger); }

    /* FAQ Styles */
    .faq-item {
      border-bottom: 1px solid var(--border-light);
    }

    .faq-item:last-child { border-bottom: none; }

    .faq-question {
      width: 100%;
      background: none;
      border: none;
      padding: 16px 20px;
      text-align: left;
      font-size: 14px;
      font-weight: 500;
      color: var(--text);
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background var(--transition);
    }

    .faq-question:hover { background: var(--bg-secondary); }

    .faq-icon {
      font-size: 16px;
      color: var(--text-tertiary);
      transition: transform var(--transition);
    }

    .faq-item.open .faq-icon { transform: rotate(45deg); }

    .faq-answer {
      max-height: 0;
      overflow: hidden;
      transition: max-height 200ms ease-out;
    }

    .faq-item.open .faq-answer { max-height: 500px; }

    .faq-answer-content {
      padding: 0 20px 16px;
      font-size: 14px;
      color: var(--text-secondary);
      line-height: 1.7;
    }

    /* Resources */
    .resource-item {
      display: flex;
      align-items: flex-start;
      gap: 16px;
      padding: 16px 0;
      border-bottom: 1px solid var(--border-light);
    }

    .resource-item:last-child { border-bottom: none; }

    .resource-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      background: var(--bg-tertiary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      flex-shrink: 0;
    }

    .resource-info { flex: 1; }

    .resource-name {
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 2px;
    }

    .resource-desc {
      font-size: 13px;
      color: var(--text-secondary);
    }

    .resource-link {
      color: var(--accent);
      font-size: 12px;
      font-weight: 500;
      text-decoration: none;
      margin-top: 4px;
      display: inline-block;
    }

    .resource-link:hover { text-decoration: underline; }

    /* Loading */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      color: var(--text-tertiary);
      gap: 12px;
    }

    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 48px 24px;
      color: var(--text-tertiary);
    }

    .empty-icon { font-size: 48px; margin-bottom: 16px; opacity: 0.5; }
    .empty-title { font-size: 16px; font-weight: 600; color: var(--text-secondary); margin-bottom: 8px; }
    .empty-desc { font-size: 14px; }

    /* Mobile */
    .mobile-toggle {
      display: none;
      position: fixed;
      top: 12px;
      left: 12px;
      z-index: 200;
      width: 40px;
      height: 40px;
      border-radius: 10px;
      background: var(--bg);
      border: 1px solid var(--border);
      cursor: pointer;
      font-size: 20px;
    }

    .sidebar-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.3);
      z-index: 99;
    }

    @media (max-width: 768px) {
      .mobile-toggle { display: flex; align-items: center; justify-content: center; }
      .sidebar { transform: translateX(-100%); }
      .sidebar.open { transform: translateX(0); }
      .sidebar-overlay.open { display: block; }
      .main { margin-left: 0; }
      .main-header { padding: 16px; padding-left: 60px; }
      .main-content { padding: 20px; }
      .content-title { font-size: 22px; }
    }

    /* Chatbot */
    .chatbot-toggle {
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: var(--accent);
      border: none;
      cursor: pointer;
      font-size: 24px;
      color: white;
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
      z-index: 1000;
      transition: all var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .chatbot-toggle:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 20px rgba(37, 99, 235, 0.4);
    }

    .chat-window {
      position: fixed;
      bottom: 92px;
      right: 24px;
      width: 380px;
      height: 520px;
      background: var(--bg);
      border-radius: 16px;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      display: flex;
      flex-direction: column;
      z-index: 1000;
      overflow: hidden;
      border: 1px solid var(--border);
    }

    .chat-header {
      background: var(--accent);
      color: white;
      padding: 16px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .chat-header-icon {
      width: 36px;
      height: 36px;
      background: rgba(255,255,255,0.2);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .chat-header-text h3 {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .chat-header-text p {
      font-size: 11px;
      opacity: 0.8;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      background: var(--bg-secondary);
    }

    .message {
      max-width: 85%;
      padding: 10px 14px;
      border-radius: 12px;
      margin-bottom: 8px;
      font-size: 13px;
      line-height: 1.5;
    }

    .message.user {
      background: var(--accent);
      color: white;
      margin-left: auto;
      border-bottom-right-radius: 4px;
    }

    .message.bot {
      background: var(--bg);
      color: var(--text);
      border: 1px solid var(--border);
      border-bottom-left-radius: 4px;
    }

    .message.typing {
      background: var(--bg);
      border: 1px solid var(--border);
      color: var(--text-tertiary);
    }

    .typing-dots {
      display: flex;
      gap: 4px;
    }

    .typing-dots span {
      width: 6px;
      height: 6px;
      background: var(--text-tertiary);
      border-radius: 50%;
      animation: typing 1.4s infinite ease-in-out;
    }

    .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
    .typing-dots span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typing {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-4px); }
    }

    .chat-input-row {
      display: flex;
      padding: 12px 16px;
      border-top: 1px solid var(--border);
      background: var(--bg);
      gap: 8px;
    }

    .chat-input {
      flex: 1;
      padding: 10px 14px;
      border: 1px solid var(--border);
      border-radius: 10px;
      font-size: 13px;
      font-family: inherit;
      transition: all var(--transition);
    }

    .chat-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-light);
    }

    .chat-send {
      padding: 10px 16px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 500;
      font-size: 13px;
      transition: all var(--transition);
    }

    .chat-send:hover { background: #1d4ed8; }
    .chat-send:disabled { opacity: 0.5; cursor: not-allowed; }

    @media (max-width: 768px) {
      .chat-window {
        width: calc(100% - 32px);
        right: 16px;
        bottom: 88px;
        height: 60vh;
      }
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useMemo, useRef } = React;

    const CONFIG = {
      CHATBOT_URL: 'https://techguide.green-king-4a92.workers.dev',
      SHEETS: {
        overview: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRIL-UCSOCH2swVsucn6ADV-4kqeA9xJLUeDt8ZN-R7K7lWXIZnDynGwAkdMRbYQRgwPBKUnLpDFXyy/pub?gid=10125262&single=true&output=csv',
        byod: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRIL-UCSOCH2swVsucn6ADV-4kqeA9xJLUeDt8ZN-R7K7lWXIZnDynGwAkdMRbYQRgwPBKUnLpDFXyy/pub?gid=2000694559&single=true&output=csv',
        apps: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRIL-UCSOCH2swVsucn6ADV-4kqeA9xJLUeDt8ZN-R7K7lWXIZnDynGwAkdMRbYQRgwPBKUnLpDFXyy/pub?gid=1431586618&single=true&output=csv',
        filtering: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRIL-UCSOCH2swVsucn6ADV-4kqeA9xJLUeDt8ZN-R7K7lWXIZnDynGwAkdMRbYQRgwPBKUnLpDFXyy/pub?gid=516137570&single=true&output=csv',
        grades: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRIL-UCSOCH2swVsucn6ADV-4kqeA9xJLUeDt8ZN-R7K7lWXIZnDynGwAkdMRbYQRgwPBKUnLpDFXyy/pub?gid=403844015&single=true&output=csv',
        parental: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRIL-UCSOCH2swVsucn6ADV-4kqeA9xJLUeDt8ZN-R7K7lWXIZnDynGwAkdMRbYQRgwPBKUnLpDFXyy/pub?gid=1618309637&single=true&output=csv',
        faq: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRIL-UCSOCH2swVsucn6ADV-4kqeA9xJLUeDt8ZN-R7K7lWXIZnDynGwAkdMRbYQRgwPBKUnLpDFXyy/pub?gid=1630426286&single=true&output=csv',
        resources: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRIL-UCSOCH2swVsucn6ADV-4kqeA9xJLUeDt8ZN-R7K7lWXIZnDynGwAkdMRbYQRgwPBKUnLpDFXyy/pub?gid=617891267&single=true&output=csv'
      }
    };

    const NAV_STRUCTURE = [
      {
        id: 'school',
        label: 'School Context',
        icon: 'üè´',
        items: [
          { id: 'overview-school', label: 'Overview', icon: 'üìã', dataKey: 'overview', filter: 'School' },
          { id: 'byod', label: 'BYOD Devices', icon: 'üíª', dataKey: 'byod' },
          { id: 'apps', label: 'App Restrictions', icon: 'üì±', dataKey: 'apps' },
          { id: 'filtering', label: 'Web Filtering', icon: 'üõ°Ô∏è', dataKey: 'filtering' },
          { id: 'grades', label: 'Grade Guidelines', icon: 'üéì', dataKey: 'grades' }
        ]
      },
      {
        id: 'home',
        label: 'Home Context',
        icon: 'üè†',
        items: [
          { id: 'overview-home', label: 'Overview', icon: 'üìã', dataKey: 'overview', filter: 'Home' },
          { id: 'parental', label: 'Parental Controls', icon: 'üë®‚Äçüë©‚Äçüëß', dataKey: 'parental' },
          { id: 'screen-time', label: 'Screen Time', icon: '‚è±Ô∏è', dataKey: 'overview', filter: 'Home', category: 'Screen Time' }
        ]
      },
      {
        id: 'reference',
        label: 'Reference',
        icon: 'üìö',
        items: [
          { id: 'faq', label: 'FAQ', icon: '‚ùì', dataKey: 'faq' },
          { id: 'resources', label: 'Resources', icon: 'üîó', dataKey: 'resources' }
        ]
      }
    ];

    async function loadSheet(url) {
      try {
        const res = await fetch(url);
        const csv = await res.text();
        return new Promise(r => Papa.parse(csv, { header: true, skipEmptyLines: true, complete: res => r(res.data) }));
      } catch (e) {
        console.error('Error:', e);
        return [];
      }
    }

    function getField(obj, ...keys) {
      for (const key of keys) {
        if (obj[key] !== undefined && obj[key] !== '') return obj[key];
      }
      return '';
    }

    function Status({ value }) {
      if (value === 'Allow') return <span className="status allow">‚úì Allow</span>;
      if (value === 'Block') return <span className="status block">‚úï Block</span>;
      return value;
    }

    function App() {
      const [data, setData] = useState({});
      const [loading, setLoading] = useState(true);
      const [activeSection, setActiveSection] = useState('school');
      const [activeItem, setActiveItem] = useState('overview-school');
      const [collapsedSections, setCollapsedSections] = useState({});
      const [search, setSearch] = useState('');
      const [expandedBlocks, setExpandedBlocks] = useState({});
      const [openFaqs, setOpenFaqs] = useState({});
      const [sidebarOpen, setSidebarOpen] = useState(false);

      // Chatbot state
      const [chatOpen, setChatOpen] = useState(false);
      const [messages, setMessages] = useState([{ role: 'bot', content: '¬°Hola! üëã Soy el asistente de tecnolog√≠a de CNG. ¬øEn qu√© puedo ayudarte hoy?\n\nHi! I\'m the CNG Technology Assistant. How can I help you today?' }]);
      const [chatInput, setChatInput] = useState('');
      const [isTyping, setIsTyping] = useState(false);
      const chatMessagesRef = useRef(null);

      // Auto-scroll chat to bottom
      useEffect(() => {
        if (chatMessagesRef.current) {
          chatMessagesRef.current.scrollTop = chatMessagesRef.current.scrollHeight;
        }
      }, [messages, isTyping]);

      useEffect(() => {
        async function loadAll() {
          const results = await Promise.all(
            Object.entries(CONFIG.SHEETS).map(async ([key, url]) => [key, await loadSheet(url)])
          );
          setData(Object.fromEntries(results));
          setLoading(false);
        }
        loadAll();
      }, []);

      const currentNav = useMemo(() => {
        for (const section of NAV_STRUCTURE) {
          const item = section.items.find(i => i.id === activeItem);
          if (item) return { section, item };
        }
        return { section: NAV_STRUCTURE[0], item: NAV_STRUCTURE[0].items[0] };
      }, [activeItem]);

      const filteredData = useMemo(() => {
        const { item } = currentNav;
        let items = data[item.dataKey] || [];

        if (item.filter) {
          items = items.filter(row => getField(row, 'Context') === item.filter);
        }
        if (item.category) {
          items = items.filter(row => getField(row, 'Category') === item.category);
        }
        if (search) {
          const s = search.toLowerCase();
          items = items.filter(row =>
            Object.values(row).some(v => (v || '').toLowerCase().includes(s))
          );
        }
        return items;
      }, [data, currentNav, search]);

      const toggleSection = (id) => {
        setCollapsedSections(prev => ({ ...prev, [id]: !prev[id] }));
      };

      const toggleBlock = (id) => {
        setExpandedBlocks(prev => ({ ...prev, [id]: !prev[id] }));
      };

      const toggleFaq = (id) => {
        setOpenFaqs(prev => ({ ...prev, [id]: !prev[id] }));
      };

      const selectItem = (sectionId, itemId) => {
        setActiveSection(sectionId);
        setActiveItem(itemId);
        setSearch('');
        setExpandedBlocks({});
        setSidebarOpen(false);
      };

      // Chatbot send message
      const sendMessage = async () => {
        if (!chatInput.trim() || isTyping) return;

        const userMsg = chatInput.trim();
        setChatInput('');
        setMessages(prev => [...prev, { role: 'user', content: userMsg }]);
        setIsTyping(true);

        try {
          const res = await fetch(CONFIG.CHATBOT_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: userMsg, ...data })
          });
          const json = await res.json();
          setMessages(prev => [...prev, { role: 'bot', content: json.reply || 'Lo siento, no pude procesar tu pregunta.' }]);
        } catch (e) {
          setMessages(prev => [...prev, { role: 'bot', content: 'Error de conexi√≥n. Por favor intenta de nuevo. üîÑ' }]);
        }
        setIsTyping(false);
      };

      if (loading) {
        return <div className="loading"><div className="spinner"></div>Loading...</div>;
      }

      const { section, item } = currentNav;

      const renderContent = () => {
        const dataKey = item.dataKey;

        // Overview content
        if (dataKey === 'overview') {
          return (
            <div>
              {filteredData.map((row, i) => (
                <div key={i} className={`content-block ${expandedBlocks[i] ? 'expanded' : ''}`}>
                  <div className="block-header" onClick={() => toggleBlock(i)}>
                    <div>
                      <div className="block-category">{getField(row, 'Category')}</div>
                      <div className="block-title">{getField(row, 'Title')}</div>
                    </div>
                    <span className="block-expand">‚ñæ</span>
                  </div>
                  <div className="block-content">
                    <p className="block-text">{getField(row, 'Description')}</p>
                  </div>
                </div>
              ))}
            </div>
          );
        }

        // Tables (BYOD, Apps, Filtering, Grades, Parental)
        if (['byod', 'apps', 'filtering', 'grades', 'parental'].includes(dataKey)) {
          const items = filteredData;
          if (!items.length) return <div className="empty-state"><div className="empty-icon">üì≠</div><div className="empty-title">No results</div></div>;

          const headers = Object.keys(items[0] || {});
          const statusCols = ['HS Students', 'MS Students', 'PS/ES Students', 'HS', 'MS', 'PS/ES'];

          return (
            <div className="content-block expanded">
              <div className="block-content">
                <div className="table-container">
                  <table>
                    <thead>
                      <tr>{headers.map(h => <th key={h}>{h}</th>)}</tr>
                    </thead>
                    <tbody>
                      {items.map((row, i) => (
                        <tr key={i}>
                          {headers.map(h => (
                            <td key={h}>
                              {statusCols.includes(h) ? <Status value={row[h]} /> : row[h]}
                            </td>
                          ))}
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          );
        }

        // FAQ
        if (dataKey === 'faq') {
          return (
            <div className="content-block expanded">
              <div className="block-content" style={{padding: 0}}>
                {filteredData.map((row, i) => (
                  <div key={i} className={`faq-item ${openFaqs[i] ? 'open' : ''}`}>
                    <button className="faq-question" onClick={() => toggleFaq(i)}>
                      <span>{getField(row, 'Question')}</span>
                      <span className="faq-icon">+</span>
                    </button>
                    <div className="faq-answer">
                      <div className="faq-answer-content">{getField(row, 'Answer')}</div>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          );
        }

        // Resources
        if (dataKey === 'resources') {
          return (
            <div className="content-block expanded">
              <div className="block-content">
                {filteredData.map((row, i) => (
                  <div key={i} className="resource-item">
                    <div className="resource-icon">
                      {getField(row, 'Context') === 'School' ? 'üè´' : getField(row, 'Context') === 'Home' ? 'üè†' : 'üìé'}
                    </div>
                    <div className="resource-info">
                      <div className="resource-name">{getField(row, 'Resource')}</div>
                      <div className="resource-desc">{getField(row, 'Description')}</div>
                      {getField(row, 'Link/Contact') && (
                        <a href={getField(row, 'Link/Contact').startsWith('http') ? getField(row, 'Link/Contact') : '#'}
                           className="resource-link" target="_blank" rel="noopener">
                          {getField(row, 'Link/Contact')} ‚Üí
                        </a>
                      )}
                    </div>
                  </div>
                ))}
              </div>
            </div>
          );
        }

        return null;
      };

      return (
        <div className="app">
          <button className="mobile-toggle" onClick={() => setSidebarOpen(!sidebarOpen)}>
            {sidebarOpen ? '‚úï' : '‚ò∞'}
          </button>
          <div className={`sidebar-overlay ${sidebarOpen ? 'open' : ''}`} onClick={() => setSidebarOpen(false)} />

          <aside className={`sidebar ${sidebarOpen ? 'open' : ''}`}>
            <div className="sidebar-header">
              <img src="https://www.cng.edu/uploaded/images/CNG_Shield_Small.png" alt="CNG" className="logo" onError={(e) => e.target.style.display='none'} />
              <div>
                <div className="logo-text">CNG Technology</div>
                <div className="logo-subtitle">Use Guide 2025-26</div>
              </div>
            </div>

            <div className="search-container">
              <input
                type="text"
                className="search-input"
                placeholder="Search..."
                value={search}
                onChange={(e) => setSearch(e.target.value)}
              />
            </div>

            <nav className="nav-container">
              {NAV_STRUCTURE.map(section => (
                <div key={section.id} className={`nav-section ${collapsedSections[section.id] ? 'collapsed' : ''}`}>
                  <div className="nav-section-header" onClick={() => toggleSection(section.id)}>
                    <span className="nav-section-icon">‚ñæ</span>
                    {section.icon} {section.label}
                  </div>
                  <ul className="nav-items">
                    {section.items.map(navItem => (
                      <li
                        key={navItem.id}
                        className={`nav-item ${activeItem === navItem.id ? 'active' : ''}`}
                        onClick={() => selectItem(section.id, navItem.id)}
                      >
                        <span className="nav-item-icon">{navItem.icon}</span>
                        {navItem.label}
                      </li>
                    ))}
                  </ul>
                </div>
              ))}
            </nav>
          </aside>

          <main className="main">
            <header className="main-header">
              <div className="breadcrumb">
                <span className="breadcrumb-item">{section.icon} {section.label}</span>
                <span className="breadcrumb-sep">/</span>
                <span className="breadcrumb-current">{item.label}</span>
              </div>
            </header>

            <div className="main-content">
              <div className="content-header">
                <h1 className="content-title">{item.label}</h1>
                <p className="content-description">
                  {item.id.includes('overview') && 'Philosophy, policies and guidelines'}
                  {item.id === 'byod' && 'Laptop specifications for the Bring Your Own Device program'}
                  {item.id === 'apps' && 'Applications allowed and blocked by grade level'}
                  {item.id === 'filtering' && 'Website categories filtered on the school network'}
                  {item.id === 'grades' && 'Technology expectations by division'}
                  {item.id === 'parental' && 'Recommended tools for home digital safety'}
                  {item.id === 'screen-time' && 'Age-appropriate screen time recommendations'}
                  {item.id === 'faq' && 'Common questions about technology at CNG'}
                  {item.id === 'resources' && 'Policies, contacts and external resources'}
                </p>
                <span className={`context-tag ${section.id === 'school' ? 'school' : section.id === 'home' ? 'home' : 'shared'}`}>
                  {section.icon} {section.label}
                </span>
              </div>

              {renderContent()}
            </div>
          </main>

          {/* Chatbot */}
          {chatOpen && (
            <div className="chat-window">
              <div className="chat-header">
                <div className="chat-header-icon">ü§ñ</div>
                <div className="chat-header-text">
                  <h3>CNG Tech Assistant</h3>
                  <p>Powered by AI</p>
                </div>
              </div>
              <div className="chat-messages" ref={chatMessagesRef}>
                {messages.map((m, i) => (
                  <div key={i} className={`message ${m.role}`}>
                    {m.content.split('\n').map((line, j) => (
                      <span key={j}>{line}<br/></span>
                    ))}
                  </div>
                ))}
                {isTyping && (
                  <div className="message typing">
                    <div className="typing-dots">
                      <span></span><span></span><span></span>
                    </div>
                  </div>
                )}
              </div>
              <div className="chat-input-row">
                <input
                  className="chat-input"
                  value={chatInput}
                  onChange={(e) => setChatInput(e.target.value)}
                  onKeyPress={(e) => e.key === 'Enter' && sendMessage()}
                  placeholder="Ask a question..."
                  disabled={isTyping}
                />
                <button className="chat-send" onClick={sendMessage} disabled={isTyping || !chatInput.trim()}>
                  Send
                </button>
              </div>
            </div>
          )}
          <button className="chatbot-toggle" onClick={() => setChatOpen(!chatOpen)}>
            {chatOpen ? '‚úï' : 'üí¨'}
          </button>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
